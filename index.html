<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Método de Montecarlo: Integrales Definidas</title>

    <style type="text/css">
      h1 {
        color: #000;
        text-align: center;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px 20px 20px 20px;
        background-color: #ccc;
      }

      input {
        border-radius: 5px;
        border-color: #cb997e;
      }

      button {
        border-radius: 5px;
        border-style: none;
        background-color: #6b705c;
        color: antiquewhite;
        height: 42px;
        width: 144px;
        font-size: medium;
      }

      img {
        height: 100%;
        object-fit: contain;
      }

      .row {
        display: flex;
      }

      .column {
        float: left;
        width: 50%;
        padding: 10px;
        height: 300px;
      }

      .footer {
        width: 100%;
        height: 100px;
        border-top: 5px solid #41963b;
        left: 0;
        bottom: 0;
        text-align: center;
        font-size: small;
      }

      .header {
        width: 100%;
        height: 100px;
        border-bottom: 5px solid #41963b;
        display: flex;
      }
    </style>

    <!-- Math.js file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.3.0/math.js"></script>

    <!-- Plotly.js file -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chance/1.0.18/chance.min.js"></script>
  </head>

  <body>
    <!-- Header -->
    <div class="header">
      <img src="./UADELOGO.png" alt="" />
      <div>
        <span><b>Trabajo práctico de Modelado y Simulación</b></span>
        <span><b>Profesor:</b> Fernando Rodolfo Acero</span>
        <span><b>Alumnas:</b> Bárbara Cerezo y Julia Espinoza</span>
      </div>
    </div>

    <!-- Title -->
    <h1>Integral Definida mediante el Método Montecarlo.</h1>

    <!-- Instrucciones -->
    <div class="row">
      <div class="column">
        <p>Valores necesarios para el cálculo</p>
        <img src="./Integral definida.png" alt="" />
      </div>
    </div>
    <br />
    <p>
      Paso 1: Ingresar la función, los puntos límites en el eje X, y la cantidad
      de disparos
    </p>
    <div class="row">
      <div class="column">
        <form id="form">
          <label for="funcion">f(x) = </label>
          <input type="text" id="funcion" name="funcion" /><br /><br />
          <label for="a">a = </label>
          <input type="text" id="a" name="a" /><br /><br />
          <label for="b">b = </label>
          <input type="text" id="b" name="b" /><br /><br />
          <label for="disparos">Cantidad de puntos a disparar = </label>
          <input type="text" id="disparos" name="disparos" /><br /><br />
          <input type="submit" value="Calcular" />
        </form>
      </div>
    </div>

    <!-- Algoritmo de Monte Carlo -->
    <div class="row">
      <div id="myDiv" class="column">
        <script type="text/javascript">
          window.onload = function () {
            //Definimos una función para generar los puntos aleatorios que se dispararán (teniendo en cuenta los límites del rectangulo)
            function generarPuntoAleatorio(min, max) {
              random = parseFloat(Math.random() * (max - min) + min).toFixed(4);

              return random;
            }

            //Definimos el Algoritmo de Newton-Rapson
            function newtonraphson(funcion, funcionDerivada, valorInicial) {
              var tolerancia = 1e-7;
              var epsilon = 2.220446049250313e-16;
              var maxCount = 20;
              var count = 0;
              var raiz;

              while (count++ < maxCount) {
                imagenFuncionEnValorInicial = math
                  .evaluate(funcion, { x: valorInicial })
                  .toString();
                imagenFuncionDerivadaEnValorInicial = math
                  .evaluate(funcionDerivada, { x: valorInicial })
                  .toString();

                if (
                  Math.abs(imagenFuncionDerivadaEnValorInicial) <=
                  epsilon * Math.abs(imagenFuncionEnValorInicial)
                ) {
                  console.log("Not Convergent");
                  return false;
                }

                raiz =
                  valorInicial -
                  imagenFuncionEnValorInicial /
                    imagenFuncionDerivadaEnValorInicial;

                if (
                  Math.abs(raiz - valorInicial) <=
                  tolerancia * Math.abs(raiz)
                ) {
                  return Math.round(raiz * 100.0) / 100.0;
                }

                valorInicial = raiz;
              }
              return false;
            }

            //Cálculamos Máx y Mín
            function calcularMaxMin(a, b, funcion) {
              //Definimos el valor N* de la ecuación Xk = a + (k(b-a))/N*
              let n = (b - a) * 10;
              //hallamos las Xk y las guardamos en un vector

              let vector = new Array(n).fill(undefined).map((value, k) => {
                return (
                  parseFloat(a) + k * ((parseFloat(b) - parseFloat(a)) / n)
                );
              });
              //Con los valores XK, calculamos los valores de F(xk)
              let valores = vector.map((valor) => {
                return math.evaluate(funcion, { x: valor }).toString();
              });

              //Definimos los valores Max y Min del rectángulo
              let valormax = Math.max.apply(Math, valores);
              let valormin = Math.min.apply(Math, valores);

              if (valormax >= 0) {
                valormax = 1.1 * valormax;
              } else {
                valormax = 0;
              }
              if (valormin >= 0) {
                valormin = 0;
              } else {
                valormin = 1.1 * valormin;
              }

              return [valormax, valormin];
            }

            function valuesOk() {
              return (
                document.getElementById("funcion").value &&
                document.getElementById("a").value &&
                document.getElementById("b").value &&
                document.getElementById("disparos").value
              );
            }

            //Definimos una función para tomar los valores que ingreso el usuario y realizamos el método de Monte Carlo
            function montecarlo() {
              if (valuesOk) {
                let y = document.getElementById("funcion").value;
                let a = document.getElementById("a").value;
                let b = document.getElementById("b").value;
                let disparos = document.getElementById("disparos").value;
                let ymax;
                let ymin;
                let raices = [];
                let max = [];
                let min = [];

                //PASO 2
                // Definimos el máx y mín del rectangulo
                let maxMin = calcularMaxMin(a, b, y);
                ymax = maxMin[0];
                ymin = maxMin[1];

                //PASO 3
                //Calculamos el área del rectangulo
                let areaRectangulo =
                  (parseFloat(b) - parseFloat(a)) *
                  (parseFloat(ymax) - parseFloat(ymin));

                //PASO 4
                //Definimos los contadores de los disparos totales y los disparos en el área definida
                let disparosTotales = 0;
                let disparosEnArea = 0;

                //Definimos los arrays de puntos aleatorios
                let puntosInX = [];
                let puntosInY = [];
                let puntosOutX = [];
                let puntosOutY = [];
                let puntosInColor = [];
                let puntosOutColor = [];

                //Definimos un ciclo para cada disparo
                while (disparosTotales < disparos) {
                  let puntoX = generarPuntoAleatorio(
                    parseFloat(a),
                    parseFloat(b)
                  );
                  let puntoY = generarPuntoAleatorio(
                    parseFloat(ymin),
                    parseFloat(ymax)
                  );

                  let inColor = "rgba(9, 107, 5, 0.5)";
                  let outColor = "rgba(145, 48, 35, 0.5)";

                  if (
                    parseFloat(
                      math.evaluate(y, { x: parseFloat(puntoX) }).toString()
                    ) > parseFloat(puntoY) &&
                    parseFloat(puntoY) > 0
                  ) {
                    disparosEnArea++;
                    puntosInX.push(puntoX);
                    puntosInY.push(puntoY);
                    puntosInColor.push(inColor);
                  } else if (
                    parseFloat(
                      math.evaluate(y, { x: parseFloat(puntoX) }).toString()
                    ) < parseFloat(puntoY) &&
                    parseFloat(puntoY) < 0
                  ) {
                    disparosEnArea--;
                    puntosInX.push(puntoX);
                    puntosInY.push(puntoY);
                    puntosInColor.push(inColor);
                  } else {
                    puntosOutX.push(puntoX);
                    puntosOutY.push(puntoY);
                    puntosOutColor.push(outColor);
                  }

                  disparosTotales++;
                }

                //Realizamos una funcion para obtener el valor de la integral
                function getMonteCarlo() {
                  let estimacionIntegral =
                    (parseFloat(disparosEnArea) / disparosTotales) *
                    parseFloat(areaRectangulo);
                  return estimacionIntegral;
                }

                //Realizamos el gráfico de la solución
                var layout = {
                  shapes: [
                    {
                      type: "rect",
                      x0: a,
                      y0: ymin,
                      x1: b,
                      y1: ymax,
                      line: {
                        color: "rgba(85, 87, 85, 1)",
                        width: 2,
                      },
                      //fillcolor: "rgba(255, 99, 71, 0.1)",
                    },
                  ],
                };

                const exprFuncion = math.compile(y);
                const xValuesFuncion = math.range(a, b, 0.1, true).toArray();
                const yValuesFuncion = xValuesFuncion.map(function (x) {
                  return exprFuncion.evaluate({ x: x });
                });

                var funcion = {
                  x: xValuesFuncion,
                  y: yValuesFuncion,
                  mode: "lines",
                  fill: "tozeroy",
                  type: "scatter",
                  name: "f(x)",
                };

                var puntosEnArea = {
                  x: puntosInX,
                  y: puntosInY,
                  mode: "markers",
                  type: "scatter",
                  name: "Puntos en área",
                  marker: {
                    color: puntosInColor,
                  },
                };

                var puntosFueraArea = {
                  x: puntosOutX,
                  y: puntosOutY,
                  mode: "markers",
                  type: "scatter",
                  name: "Puntos fuera área",
                  marker: {
                    color: puntosOutColor,
                  },
                };

                var data = [funcion, puntosEnArea, puntosFueraArea];

                Plotly.newPlot("myDiv", data, layout);
                document.getElementById("area").innerHTML = getMonteCarlo();
              }
            }

            //Actualizamos el gráfico cada vez que el usuario presiona el botón "Calcular"
            document.getElementById("form").onsubmit = function (event) {
              event.preventDefault();
              montecarlo();
            };

            //Realizamos el Método de Montecarlo
            montecarlo();
          };
        </script>
      </div>
    </div>

    <h2>
      La estimación de la integral definida por el método de Monte Carlo es de
      <span id="area"></span>
    </h2>

    <!-- Footer -->
    <div class="footer">
      <span style="padding-top: 10px"
        ><b>Trabajo práctico de Modelado y Simulación</b></span
      >
      <span><b>Profesor:</b> Acero, Fernando Rodolfo</span>
      <span><b>Alumnas:</b> Bárbara Cerezo y Julia Espinoza.</span>
    </div>
  </body>
</html>
